PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE Page_Entity (
	`id`       INTEGER PRIMARY KEY,

    `parent_id` INTEGER,
	`path`      VARCHAR(127) NOT NULL,

    `template` VARCHAR(128),

    FOREIGN KEY (`parent_id`) REFERENCES Page_Entity (`id`) ON DELETE CASCADE
);
CREATE TABLE Email (
	`id` INTEGER PRIMARY KEY, -- must be an integer, to have AUTOINCREMENT on it

    `status`    CHAR(1) NOT NULL,
        
    `email`     VARCHAR(255) NOT NULL,

    `user_id` INTEGER,
        -- ID of the User owning this email (NULL if it was not claimed - owned by some Guest)

    FOREIGN KEY(`user_id`) REFERENCES User_Entity(`id`)
);
INSERT INTO "Email" VALUES(1,'A','agnes@test.test',NULL);
INSERT INTO "Email" VALUES(2,'A','beata@test.test',NULL);
INSERT INTO "Email" VALUES(3,'A','ela@test.test',NULL);
INSERT INTO "Email" VALUES(4,'A','natka@test.test',NULL);
INSERT INTO "Email" VALUES(5,'A','wanda@test.test',NULL);
CREATE TABLE Email_Verification_Keys (
	`id` INTEGER PRIMARY KEY, -- must be an integer, to have AUTOINCREMENT on it

    `email_id`  INTEGER      NOT NULL,
    `key`       VARCHAR(128) NOT NULL,  -- 'secret' key, known only to email owner

    `handler`   VARCHAR(128) NOT NULL,  -- module, that will do the verification
    `params`    VARCHAR(255) NOT NULL,  -- parameters passed to the module

    FOREIGN KEY(`email_id`) REFERENCES Email(`id`)
);
CREATE TABLE User_Entity (
	`id` INTEGER PRIMARY KEY, -- must be an integer, to have AUTOINCREMENT on it

	`login` VARCHAR(64) NOT NULL,
		-- User's login

    `status` VARCHAR(10) NOT NULL,

    `name`      VARCHAR(128),

    `pass_enc` VARCHAR(512),
    `email_id` INTEGER NOT NULL,
        -- Primary email owned and used by the User.

    FOREIGN KEY(`email_id`) REFERENCES Email(`id`)
);
INSERT INTO "User_Entity" VALUES(1,'aga','Enabled','Agnieszka',NULL,1);
INSERT INTO "User_Entity" VALUES(2,'beti','Enabled','Beata',NULL,2);
INSERT INTO "User_Entity" VALUES(3,'ela','Enabled','El≈ºbieta',NULL,3);
INSERT INTO "User_Entity" VALUES(4,'nataly','Guest','Natalia',NULL,4);
INSERT INTO "User_Entity" VALUES(5,'wanda','Disabled','Wanda L.',NULL,5);
CREATE UNIQUE INDEX Page_Entity_id   ON Page_Entity (id);
CREATE UNIQUE INDEX Page_Entity_path ON Page_Entity (parent_id, path);
CREATE UNIQUE INDEX Email_email ON Email (email);
CREATE UNIQUE INDEX User_Entity_login ON User_Entity (login);
CREATE INDEX User_Entity_email ON User_Entity (email_id);
COMMIT;
